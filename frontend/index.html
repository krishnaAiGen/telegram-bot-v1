<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Persona Dashboard</title>
    <style>
        :root {
            --primary-color: #4F46E5; /* Indigo */
            --primary-hover: #4338CA;
            --accent-color: #EC4899;  /* Pink */
            --accent-hover: #DB2777;
            --danger-color: #EF4444;
            --success-color: #10B981;
            --bg-color: #F8FAFC;      /* Slate 50 */
            --card-bg: #FFFFFF;
            --border-color: #E2E8F0;  /* Slate 200 */
            --text-dark: #1E293B;     /* Slate 800 */
            --text-medium: #64748B;   /* Slate 500 */
            --text-light: #94A3B8;    /* Slate 400 */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .screen { display: none; }
        .screen.active { display: block; }

        /* --- Components --- */
        .btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 20px; border: none; border-radius: 8px;
            font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s ease;
            white-space: nowrap;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn:disabled { background-color: var(--text-light); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-accent { background-color: var(--accent-color); color: white; }
        .btn-accent:hover:not(:disabled) { background-color: var(--accent-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background: white; color: var(--text-dark); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #f8fafc; }
        
        /* --- Forms --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); }
        input[type="text"], input[type="email"], input[type="password"], textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px;
            background-color: white; transition: all 0.2s ease;
        }
        input:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); outline: none; }
        textarea { resize: vertical; min-height: 120px; }
        input[type="checkbox"] { width: auto; margin-right: 10px; }

        /* --- Auth Screen --- */
        .auth-container { max-width: 420px; margin: 100px auto; background: var(--card-bg); padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        .auth-container h1 { font-size: 28px; margin-bottom: 30px; }

        /* --- Dashboard --- */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 30px; }
        .dashboard-header h1 { font-size: 28px; }

        .section { background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .section-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);}
        .section-header h2 { font-size: 22px; margin: 0; }
        .section-header .actions { display: flex; flex-wrap: wrap; gap: 10px; }
        
        #persona-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .persona-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; background: white; transition: all 0.2s ease; display: flex; flex-direction: column; }
        .persona-card:hover { border-color: var(--primary-color); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.07); }
        .persona-card h3 { font-size: 18px; color: var(--primary-color); margin-bottom: 4px; }
        .persona-card .role { font-weight: 600; color: var(--text-medium); margin-bottom: 10px; }
        .persona-card .tagline { font-style: italic; color: var(--text-light); margin-bottom: 15px; font-size: 14px; flex-grow: 1; }
        .tags { display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px; margin-top: 10px;}
        .tag { background: var(--bg-color); color: var(--text-medium); padding: 4px 10px; border-radius: 16px; font-weight: 500; }
        .card-actions { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        
        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal { background: var(--bg-color); border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 12px 12px 0 0;}
        .modal-header h2 { margin-bottom: 0; font-size: 20px; }
        .modal-close { font-size: 24px; cursor: pointer; border: none; background: none; color: var(--text-medium); }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 16px; border-bottom: 3px solid transparent; color: var(--text-medium); font-weight: 500;}
        .tab-button.active { border-bottom-color: var(--primary-color); font-weight: 600; color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .example-field { border: 1px dashed var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; position: relative; }
        .delete-example-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 18px; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--border-color); text-align: right; background: white; border-radius: 0 0 12px 12px; display:flex; justify-content: flex-end; gap: 10px;}
        
        /* --- Notification --- */
        #notification {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 25px; border-radius: 8px; color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0; visibility: hidden; transition: all 0.4s ease; z-index: 2000;
        }
        #notification.show { opacity: 1; visibility: visible; bottom: 30px; }
        #notification.success { background-color: var(--success-color); }
        #notification.error { background-color: var(--danger-color); }
        #notification.info { background-color: var(--text-medium); }

        /* --- Empty State --- */
        .empty-state { text-align: center; padding: 40px; color: var(--text-medium); }
        .empty-state-icon { font-size: 48px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <!-- =========== LOGIN SCREEN =========== -->
    <div class="screen active" id="login-screen">
        <div class="auth-container">
            <h1>AI Persona Dashboard</h1>
            <div class="form-group">
                <label for="login-email" style="text-align: left;">Email</label>
                <input type="email" id="login-email" value="demo@persona.ai">
            </div>
            <div class="form-group">
                <label for="login-password" style="text-align: left;">Password</label>
                <input type="password" id="login-password" value="password">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="handleLogin()">Log In</button>
        </div>
    </div>

    <!-- =========== DASHBOARD SCREEN =========== -->
    <div class="screen" id="dashboard-screen">
        <div class="container">
            <div class="dashboard-header">
                <h1>AI Persona Dashboard</h1>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </div>

            <!-- Generator Section -->
            <div class="section">
                <div class="section-header">
                    <h2>Create New Personas</h2>
                </div>
                <div class="form-group">
                    <label for="goal-prompt">Describe your bot's high-level goal to generate a new team of AI assistants:</label>
                    <textarea id="goal-prompt" placeholder="e.g., I need a friendly and professional team for a new SaaS product's Discord server. We need a community manager, a tech support agent, and a fun announcements bot..."></textarea>
                </div>
                <button id="generate-btn" class="btn btn-primary" onclick="handleGenerate()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.302 1.256a1.5 1.5 0 0 0-2.604 0l-1.704 2.952a.5.5 0 0 0 .434.748H6.5v1a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .5-.5v-1h1.97a.5.5 0 0 0 .434-.748zM4.994 11.691a2.5 2.5 0 0 0 5.012 0l1.767-3.06a.5.5 0 0 0-.433-.748H10.5v-1a.5.5 0 0 0-.5-.5h-2a.5.5 0 0 0-.5.5v1H6.03a.5.5 0 0 0-.433.748z"/></svg>
                    Generate AI Team
                </button>
            </div>
            
            <!-- Active Team Section -->
            <div class="section">
                <div class="section-header">
                    <h2>Your Active Bot Team</h2>
                    <!-- MOVED: Actions including Deploy are now here -->
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="showLibraryModal(true)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02a4 4 0 0 1 3.23.006c1.378.139 2.798.62 3.68 1.02a.5.5 0 0 0 .707-.455v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783"/></svg>
                            Add from Library
                        </button>
                        <button class="btn btn-danger" onclick="handleClearTeam()">Clear Team</button>
                        <button id="deploy-btn" class="btn btn-accent" onclick="handleDeploy()">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/></svg>
                            Deploy Team
                        </button>
                    </div>
                </div>
                <div id="persona-grid-container">
                    <div class="empty-state" id="no-personas-message">
                        <div class="empty-state-icon">🤖</div>
                        <p>Your active team is empty.</p>
                        <span>Generate a new team or add personas from your library.</span>
                    </div>
                    <div id="persona-grid"></div>
                </div>
            </div>

            <!-- REMOVED: Deployment Section was here. It's now integrated above. -->

        </div>
    </div>

    <!-- =========== MODALS (No change) =========== -->
    <div class="modal-overlay" id="edit-persona-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">Edit Persona</h2>
                <button class="modal-close" onclick="showEditModal(false)">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-tabs">
                    <button class="tab-button active" onclick="showTab('core', event)">Core Identity</button>
                    <button class="tab-button" onclick="showTab('voice', event)">Voice & Style</button>
                    <button class="tab-button" onclick="showTab('knowledge', event)">Knowledge & Rules</button>
                    <button class="tab-button" onclick="showTab('examples', event)">Examples</button>
                </div>

                <!-- Core Identity Tab -->
                <div class="tab-content active" id="tab-core">
                    <div class="form-group"><label for="edit-persona_name">Persona Name</label><input type="text" id="edit-persona_name"></div>
                    <div class="form-group"><label for="edit-role">Role</label><input type="text" id="edit-role"></div>
                    <div class="form-group"><label for="edit-tagline">Tagline</label><input type="text" id="edit-tagline"></div>
                    <div class="form-group"><label for="edit-key_traits">Key Traits (comma-separated)</label><input type="text" id="edit-key_traits"></div>
                    <div class="form-group"><label for="edit-expertise">Expertise (comma-separated)</label><input type="text" id="edit-expertise"></div>
                </div>

                <!-- Voice & Style Tab -->
                <div class="tab-content" id="tab-voice">
                    <div class="form-group"><label for="edit-tone">Tone (e.g., Witty, formal, enthusiastic)</label><input type="text" id="edit-tone"></div>
                    <div class="form-group"><label for="edit-style">Style</label><textarea id="edit-style" placeholder="Describe the persona's communication style."></textarea></div>
                    <div class="form-group"><label for="edit-language_habits">Language Habits (one per line)</label><textarea id="edit-language_habits" placeholder="e.g., Prefers short sentences&#10;Often uses questions"></textarea></div>
                    <div class="form-group"><label><input type="checkbox" id="edit-allow_emojis"> Allow use of Emojis</label></div>
                </div>
                
                <!-- Knowledge Tab -->
                <div class="tab-content" id="tab-knowledge">
                    <div class="form-group"><label for="edit-will_defer_on">Knowledge Boundaries (topics to defer on, one per line)</label><textarea id="edit-will_defer_on"></textarea></div>
                    <div class="form-group"><label for="edit-refusal_message">Refusal Message</label><textarea id="edit-refusal_message" placeholder="e.g., That's a bit outside my area of expertise."></textarea></div>
                    <div class="form-group"><label for="edit-interaction_rules">Interaction Rules (how it acts with other personas, one per line)</label><textarea id="edit-interaction_rules"></textarea></div>
                </div>

                <!-- Examples Tab -->
                <div class="tab-content" id="tab-examples">
                    <div id="examples-container"></div>
                    <button class="btn btn-secondary" onclick="addExampleField()">+ Add Example</button>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="showEditModal(false)">Cancel</button>
                <button class="btn btn-primary" onclick="handleSavePersona()">Save Changes</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="library-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Persona Library</h2>
                <button class="modal-close" onclick="showLibraryModal(false)">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="library-search" onkeyup="renderPersonaLibrary()" placeholder="Search library by name...">
                </div>
                <div id="library-grid-container">
                     <div class="empty-state" id="no-library-message">
                        <div class="empty-state-icon">📚</div>
                        <p>Your library is empty.</p>
                        <span>Save personas from your active team to reuse them later.</span>
                    </div>
                    <div id="library-grid" style="display: grid; gap: 15px; grid-template-columns: 1fr 1fr;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- =========== NOTIFICATION (No change) =========== -->
    <div id="notification"></div>


    <!-- =========== SCRIPT (No change in logic) =========== -->
    <script>
        // --- BEST PRACTICE: DEFINE API URL ---
        const API_BASE_URL = 'http://127.0.0.1:8000';
    
        // --- STATE MANAGEMENT ---
        let activeTeam = [];
        let personaLibrary = [];
        let editingPersonaId = null;
    
        // --- MOCK DATA (We keep the library data for the demo) ---
        const mockLibraryPersonas = [
             { id: `lib_${Date.now()}_1`, "persona_name": "Crypto OG", "tagline": "Been here since the Bitcointalk days.", "role": "Community Elder", "expertise": ["Bitcoin history", "Market cycles", "Self-custody"], "signature_voice": { "tone": "nostalgic, wise, cynical", "style": "short anecdotes", "language_habits": ["compares new to old", "uses slang like 'sats'"] }, "allow_emojis": true, "key_traits": ["Nostalgic", "Principled", "Skeptical"], "knowledge_boundaries": { "will_defer_on": ["DeFi yield strategies"], "refusal_message": "That's a bit too degen for me, fren." }, "examples": [{ "user": "Is this new token a good buy?", "assistant": "Reminds me of the 2017 ICO craze. I'd wait and see." }], "interaction_rules": ["Handles questions about crypto history."] },
             { id: `lib_${Date.now()}_2`, "persona_name": "Trendsetter Travis", "tagline": "Crafting Hype, One Tweet at a Time.", "role": "Social Media Campaign Manager", "expertise": ["Twitter campaigns", "Audience engagement", "Trend analysis"], "signature_voice": { "tone": ["engaging", "witty", "casual"], "style": "short, impactful sentences", "language_habits": ["uses popular hashtags", "employs crypto slang"] }, "allow_emojis": true, "key_traits": ["Creative", "Trend-savvy", "Analytical"], "knowledge_boundaries": { "will_defer_on": ["deep technical details", "financial advice"], "refusal_message": "That's a question for the tech team, I just make the memes shine!" }, "examples": [{ "user": "How do we go viral?", "assistant": "It's all about timing and a fire meme. Let's hijack the latest trend and connect it to our brand. LFG!" }], "interaction_rules": ["Leads Twitter campaigns.", "Works with Harmony Weaver to promote Discord events."] }
        ];
    
        // --- RENDER & DISPLAY FUNCTIONS ---
        function renderActiveTeam() {
            const grid = document.getElementById('persona-grid');
            const message = document.getElementById('no-personas-message');
            grid.innerHTML = '';
            document.getElementById('deploy-btn').disabled = activeTeam.length === 0;
            if (activeTeam.length === 0) {
                message.style.display = 'block';
                grid.style.display = 'none';
                return;
            }
            message.style.display = 'none';
            grid.style.display = 'grid';
            activeTeam.forEach((persona) => {
                const card = document.createElement('div');
                card.className = 'persona-card';
                card.innerHTML = `
                    <h3>${persona.persona_name || 'Unnamed Persona'}</h3>
                    <p class="role">${persona.role || 'No role defined'}</p>
                    <p class="tagline">"${persona.tagline || ''}"</p>
                    <div class="tags">${(persona.key_traits || []).slice(0, 3).map(trait => `<span class="tag">${trait}</span>`).join('')}</div>
                    <div class="card-actions">
                        <button class="btn btn-secondary btn-sm" onclick="handleSaveToLibrary('${persona.id}')">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/><path d="M5 8h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1"/></svg>
                           Save to Library
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="handleEditClick('${persona.id}')">✏️ Edit</button>
                        <button class="btn btn-danger btn-sm" style="padding: 10px;" onclick="handleDeleteClick('${persona.id}')">🗑️</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function renderPersonaLibrary() {
            const grid = document.getElementById('library-grid');
            const message = document.getElementById('no-library-message');
            const searchInput = document.getElementById('library-search').value.toLowerCase();
            grid.innerHTML = '';
            
            const filteredLibrary = personaLibrary.filter(p => p.persona_name.toLowerCase().includes(searchInput));
    
            if (filteredLibrary.length === 0) {
                message.style.display = 'block';
                grid.style.display = 'none';
                if(personaLibrary.length > 0) {
                    message.querySelector('p').textContent = 'No personas match your search.';
                    message.querySelector('span').textContent = 'Try clearing the search bar.';
                }
                return;
            }
            message.style.display = 'none';
            grid.style.display = 'grid';
    
            filteredLibrary.forEach(persona => {
                const card = document.createElement('div');
                card.className = 'persona-card';
                card.innerHTML = `
                    <h3>${persona.persona_name}</h3>
                    <p class="role">${persona.role}</p>
                    <div class="tags">${(persona.key_traits || []).slice(0, 3).map(trait => `<span class="tag">${trait}</span>`).join('')}</div>
                    <div class="card-actions">
                         <button class="btn btn-accent" onclick="handleAddFromLibrary('${persona.id}')">
                           + Add to Team
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
    
        // --- UI & MODAL FUNCTIONS ---
        async function loadInitialPersonas() {
            showNotification("Loading latest team from database...", 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/get-latest-personas/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const personas = await response.json();
                if (personas && Array.isArray(personas)) {
                    activeTeam = personas.map((p, index) => ({ ...p, id: `db_${Date.now()}_${index}` }));
                    showNotification("Team loaded successfully!", 'success');
                } else {
                    activeTeam = [];
                }
            } catch (error) {
                console.error("Could not fetch personas:", error);
                showNotification("Could not load personas from the database.", 'error');
                activeTeam = [];
            } finally {
                renderActiveTeam();
            }
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
    
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = '';
            notification.classList.add(type);
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function showEditModal(shouldShow) {
            document.getElementById('edit-persona-modal').style.display = shouldShow ? 'flex' : 'none';
        }
    
        function showLibraryModal(shouldShow) {
            const modal = document.getElementById('library-modal');
            if (shouldShow) {
                modal.style.display = 'flex';
                renderPersonaLibrary();
            } else {
                modal.style.display = 'none';
            }
        }
    
        function showTab(tabName, event) {
            const modal = event.target.closest('.modal');
            modal.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            modal.querySelector(`#tab-${tabName}`).classList.add('active');
            modal.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            event.target.classList.add('active');
        }
    
        // --- EVENT HANDLERS ---
        function handleLogin() {
            console.log("Simulating login...");
            showScreen('dashboard-screen');
            initializeApp();
        }
    
        function handleLogout() {
            if (confirm("Are you sure you want to logout?")) {
                console.log("Simulating logout...");
                activeTeam = [];
                showScreen('login-screen');
            }
        }
    
        async function handleGenerate() {
            const goal = document.getElementById('goal-prompt').value;
            const btn = document.getElementById('generate-btn');
            if (!goal.trim()) {
                showNotification("Please describe your bot's goal first.", 'error');
                return;
            }
            btn.disabled = true;
            btn.innerHTML = 'Generating...';
            showNotification("Generating AI team... this may take a moment.", 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/generate-personas/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goal: goal }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! Status: ${response.status}`);
                }
                const result = await response.json();
                console.log("Backend response:", result);
                showNotification("Generation complete! Refreshing team...", 'success');
                await loadInitialPersonas();
            } catch (error) {
                console.error("Failed to generate personas:", error);
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.302 1.256a1.5 1.5 0 0 0-2.604 0l-1.704 2.952a.5.5 0 0 0 .434.748H6.5v1a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .5-.5v-1h1.97a.5.5 0 0 0 .434-.748zM4.994 11.691a2.5 2.5 0 0 0 5.012 0l1.767-3.06a.5.5 0 0 0-.433-.748H10.5v-1a.5.5 0 0 0-.5-.5h-2a.5.5 0 0 0-.5.5v1H6.03a.5.5 0 0 0-.433.748z"/></svg> Generate AI Team`;
            }
        }
        
        function handleClearTeam() {
            if (activeTeam.length === 0) {
                showNotification("Active team is already empty.", 'info');
                return;
            }
            if (confirm("Are you sure you want to clear your active team? This won't affect your library.")) {
                activeTeam = [];
                renderActiveTeam();
                showNotification("Active team cleared.", 'success');
            }
        }
    
        function handleSaveToLibrary(personaId) {
            const personaToSave = activeTeam.find(p => p.id === personaId);
            if (!personaToSave) return;
            
            if (personaLibrary.some(p => p.persona_name === personaToSave.persona_name)) {
                showNotification(`'${personaToSave.persona_name}' is already in your library.`, 'error');
                return;
            }
            
            const newLibraryEntry = JSON.parse(JSON.stringify(personaToSave));
            newLibraryEntry.id = `lib_${Date.now()}`;
            personaLibrary.push(newLibraryEntry); 
            showNotification(`'${personaToSave.persona_name}' saved to library!`, 'success');
            renderPersonaLibrary();
        }
    
        function handleAddFromLibrary(personaId) {
            const personaToAdd = personaLibrary.find(p => p.id === personaId);
            if (!personaToAdd) return;
            
            if (activeTeam.some(p => p.persona_name === personaToAdd.persona_name)) {
                showNotification(`'${personaToAdd.persona_name}' is already in your active team.`, 'error');
                return;
            }
            
            const newTeamMember = JSON.parse(JSON.stringify(personaToAdd));
            newTeamMember.id = `active_${Date.now()}`;
            activeTeam.push(newTeamMember);
            
            renderActiveTeam();
            showLibraryModal(false);
            showNotification(`'${newTeamMember.persona_name}' added to your team.`, 'success');
        }
    
        function handleDeleteClick(personaId) {
            const personaName = activeTeam.find(p => p.id === personaId)?.persona_name || 'this persona';
            if (confirm(`Are you sure you want to delete ${personaName} from your active team?`)) {
                activeTeam = activeTeam.filter(p => p.id !== personaId);
                renderActiveTeam();
                showNotification(`${personaName} has been deleted.`, 'success');
            }
        }
    
        function handleDeploy() {
            if (activeTeam.length === 0) {
                showNotification("You have no active personas to deploy!", 'error');
                return;
            }
            if (confirm(`Are you sure you want to deploy these ${activeTeam.length} personas to your live bot? This will overwrite the current configuration.`)) {
                console.log("Simulating deployment of:", activeTeam);
                showNotification("Deployment successful! Your bot is now updated.", 'success');
            }
        }
        
        function handleEditClick(personaId) {
            editingPersonaId = personaId;
            const persona = activeTeam.find(p => p.id === personaId);
            if (!persona) return;
    
            document.getElementById('modal-title').innerText = `Edit: ${persona.persona_name || ''}`;
            
            const signature_voice = persona.signature_voice || {};
            const knowledge_boundaries = persona.knowledge_boundaries || {};
    
            document.getElementById('edit-persona_name').value = persona.persona_name || '';
            document.getElementById('edit-role').value = persona.role || '';
            document.getElementById('edit-tagline').value = persona.tagline || '';
            document.getElementById('edit-key_traits').value = (persona.key_traits || []).join(', ');
            document.getElementById('edit-expertise').value = (persona.expertise || []).join(', ');
            document.getElementById('edit-tone').value = signature_voice.tone || '';
            document.getElementById('edit-style').value = signature_voice.style || '';
            document.getElementById('edit-language_habits').value = (signature_voice.language_habits || []).join('\n');
            document.getElementById('edit-allow_emojis').checked = persona.allow_emojis || false;
            document.getElementById('edit-will_defer_on').value = (knowledge_boundaries.will_defer_on || []).join('\n');
            document.getElementById('edit-refusal_message').value = knowledge_boundaries.refusal_message || '';
            document.getElementById('edit-interaction_rules').value = (persona.interaction_rules || []).join('\n');
            
            const examplesContainer = document.getElementById('examples-container');
            examplesContainer.innerHTML = '';
            (persona.examples || []).forEach((ex) => addExampleField(ex.user, ex.assistant));
    
            showEditModal(true);
            showTab('core', { target: document.querySelector('.modal-tabs .tab-button') });
        }
    
        function handleSavePersona() {
            if (!editingPersonaId) return;
            const personaIndex = activeTeam.findIndex(p => p.id === editingPersonaId);
            if (personaIndex === -1) return;
    
            console.log("Simulating save for persona ID:", editingPersonaId);
            const updatedPersona = activeTeam[personaIndex];
            
            updatedPersona.persona_name = document.getElementById('edit-persona_name').value;
            updatedPersona.role = document.getElementById('edit-role').value;
            updatedPersona.tagline = document.getElementById('edit-tagline').value;
            updatedPersona.key_traits = document.getElementById('edit-key_traits').value.split(',').map(s => s.trim()).filter(Boolean);
            updatedPersona.expertise = document.getElementById('edit-expertise').value.split(',').map(s => s.trim()).filter(Boolean);
            
            updatedPersona.signature_voice = updatedPersona.signature_voice || {};
            updatedPersona.signature_voice.tone = document.getElementById('edit-tone').value;
            updatedPersona.signature_voice.style = document.getElementById('edit-style').value;
            updatedPersona.signature_voice.language_habits = document.getElementById('edit-language_habits').value.split('\n').filter(Boolean);
            
            updatedPersona.allow_emojis = document.getElementById('edit-allow_emojis').checked;
    
            updatedPersona.knowledge_boundaries = updatedPersona.knowledge_boundaries || {};
            updatedPersona.knowledge_boundaries.will_defer_on = document.getElementById('edit-will_defer_on').value.split('\n').filter(Boolean);
            updatedPersona.knowledge_boundaries.refusal_message = document.getElementById('edit-refusal_message').value;
            
            updatedPersona.interaction_rules = document.getElementById('edit-interaction_rules').value.split('\n').filter(Boolean);
            
            const examplesContainer = document.getElementById('examples-container');
            const exampleFields = examplesContainer.querySelectorAll('.example-field');
            updatedPersona.examples = [];
            exampleFields.forEach(field => {
                const user = field.querySelector('.example-user').value;
                const assistant = field.querySelector('.example-assistant').value;
                if(user && assistant) {
                    updatedPersona.examples.push({ user, assistant });
                }
            });
    
            activeTeam[personaIndex] = updatedPersona;
            showEditModal(false);
            renderActiveTeam();
            showNotification(`'${updatedPersona.persona_name}' has been updated.`, 'success');
            editingPersonaId = null;
        }
        
        function addExampleField(user = '', assistant = '') {
            const container = document.getElementById('examples-container');
            const exampleDiv = document.createElement('div');
            exampleDiv.className = 'example-field';
            exampleDiv.innerHTML = `
                <button class="delete-example-btn" onclick="this.parentElement.remove()">&times;</button>
                <label>User Says:</label>
                <textarea class="example-user" placeholder="Example user input...">${user}</textarea>
                <label style="margin-top: 10px;">Bot Replies:</label>
                <textarea class="example-assistant" placeholder="Example assistant response...">${assistant}</textarea>
            `;
            container.appendChild(exampleDiv);
        }
    
        // --- INITIALIZATION ---
        function initializeApp() {
            personaLibrary = JSON.parse(JSON.stringify(mockLibraryPersonas));
            renderPersonaLibrary();
            loadInitialPersonas();
        }
    </script>
</body>
</html>